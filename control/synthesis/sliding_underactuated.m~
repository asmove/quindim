function u = sliding_underactuated(sys, etas, poles, params_lims)    
    params_hat_n = sys.descrip.model_params';
    [n, m] = size(sys.dyn.Z);
    
    for i = 1:m
        param_lims = params_lims(i, 1:2);
        param_hat = params_hat_n(i);
        
        if((param_hat >= param_lims(1)) || (param_hat <= param_lims(2)))
            continue;
        else
            error('Estimation parameters MUST be within interval!');
        end
    end
    
    % Matrices size
    [n, m] = size(sys.dyn.Z);
        
    params_s = sys.descrip.syms.';
    params_hat_s = add_symsuffix(params_s, '_hat');
        
    [alpha_a, alpha_u, lambda_a, lambda_u] = alpha_lambda(poles, m, n);
    [Ms, fs] = Ms_fs(sys, alpha_a, alpha_u);
    [s, sr, sr_p] = s_sr_srp(sys, alpha_a, alpha_u, lambda_a, lambda_u);
    
    % Parameter limits
    params_min = params_lims(1, :);
    params_max = params_lims(2, :);
    
    fs_hat_s = subs(fs, params_s, params_hat_s);
    
    q_p = [sys.kin.q; sys.kin.p];

    % Dynamics uncertainties
    Fs = dynamics_uncertainties(fs_s, q_p, params_s, params_lims);
    
    % Mass matrix uncertainties
    [D, D_tilde, Ms_hat] = mass_uncertainties(Ms_s, q_p, params_s, params_lims);

    % Gains
    inv_I_Dtilde = inv(eye(m) - D_tilde);
    k = simplify_(inv_I_Dtilde*(Fs + D*abs(sr_p + fs_hat_s) + etas));
    %k = simplify_(Fs + etas);
    k = subs(k, params_hat_s, params_hat_n);
    K = vpa(diag(k));
    eig(D_tilde)
    Ms_hat_n = subs(Ms_hat_s, params_hat_s, params_hat_n);
    fs_hat_n = subs(fs_hat_s, params_hat_s, params_hat_n);
    
    % Control output
    u_control = -inv(Ms_hat)*(fs_hat_n + sr_p + K*sign(s));
    u.output = vpa(u_control);
    
    % Manifold parameters
    u.lambda = [lambda_a, lambda_u];
    u.alpha = [alpha_a, alpha_u];
    
    u.C = C;
    
    % Dynamics approximations
    u.Ms_s = Ms_s;
    u.Ms_hat = Ms_hat;
    
    u.fs = fs_s;
    u.fs_hat = fs_hat_s;
    
%     % Maximum and minimum of mass matrix and dynamic vector
%     u.D = D;
%     u.D_tilde = D_tilde;
    u.Fs = Fs;
    
    % Sliding surface
    u.s = s;
       
    u.sr = sr;
    u.sr_p = sr_p;
        
    u.params = params_s;
    u.params_hat = params_hat_s;
    
    u.eta = etas;
end

